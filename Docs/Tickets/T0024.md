# Ticket: T0024 - Timeline View v1 (Messages-first)

## Goal
Add a **Timeline** page that displays time-ordered investigative events (start with **MessageEvent** only), with filters, pagination/virtualization, and one-click provenance drill-down.

## Context
We already ingest messages (UFDR/XLSX), have provenance drill-down and search, and have Targets + Global Persons. Timeline is a core investigative surface and will become the backbone for future event types (calls, locations, media).

## Scope
### In scope
- New **Timeline** page in left-nav.
- Timeline query pipeline (Infrastructure service) that returns timeline rows with:
  - event timestamp (UTC stored; local display)
  - event type (Message for v1)
  - participants (resolved to Target/Global Person where available)
  - short snippet/preview (safe, bounded)
  - provenance citation + “View Source” action + “Copy citation”
- Filters (v1):
  - date range (from/to)
  - target/global person filter (optional)
  - direction (in/out/unknown) if available
  - text contains (optional; best-effort, can reuse existing FTS query style)
- Paging/virtualization so UI stays responsive on large datasets.
- Audit log entry for Timeline searches (query + filters + case id + correlation id).

### Out of scope
- Calls, locations, media events (future tickets)
- Complex clustering/grouping, analytics, heatmaps
- Cross-case timeline (future)

## Acceptance Criteria (Testable)
- [ ] Timeline page loads and displays MessageEvents ordered by timestamp descending.
- [ ] Filters work: date range + target/global person (and direction if available).
- [ ] Timeline list does not block UI and supports cancellation (scrolling/filtering remains responsive).
- [ ] Each row supports:
  - [ ] “View Source” opens evidence item + locator
  - [ ] “Copy citation” copies EvidenceItem + SourceLocator citation
- [ ] Timeline searches are audited with filters and timestamp.
- [ ] Works on a dataset with 100k+ messages without UI freezing (paging/virtualization).

## Deliverables
- Code:
  - `TimelineQueryService` (Infrastructure) + DTOs for timeline rows
  - ViewModel + cancellable async loading
  - Minimal nav wiring to add Timeline page
  - Audit event logging for Timeline searches
- UI:
  - Timeline page with filter panel + list (virtualized)
  - Empty state + “Clear filters”
  - Row actions: View Source, Copy Citation, Open Message/Thread (if already supported)
- Database (migrations):
  - Only if required (e.g., add index on MessageEvent timestamp)
- Tests:
  - Query ordering + filter correctness tests
  - Audit write verification for timeline search
- Docs:
  - Update `Docs/DATA_MODEL.md` if new index/migration added
  - Fill `T0024.closeout.md` after merge

## Data Model Changes
- None expected.
- If needed for performance:
  - Add index: `MessageEvent(TimestampUtc)` or your equivalent timestamp column.

## Provenance & Audit Requirements
### Provenance
Every timeline row must surface:
- SourceEvidenceItemId
- SourceLocator (precise)
- IngestModuleVersion (if already available; otherwise not required for UI but must remain stored on derived records)

### Audit
Log:
- TimelineSearchExecuted (case id, filters, query text if any, result count, correlation id)

## Performance & Resource Management Requirements
- Async/await for all I/O; never block UI thread.
- Paging/virtualization: do not load all MessageEvents into memory.
- CancellationToken supported end-to-end.
- Dispose DB contexts/commands/readers deterministically.

## Implementation Notes / Edge Cases
- Timestamp normalization:
  - Query/store in UTC; display in local time.
  - Missing timestamps: still display, but sort deterministically (e.g., nulls last).
- Participant resolution:
  - Use existing target/global-person resolution logic used by Search/Where-Seen so naming is consistent.
- Snippet:
  - Bounded length; avoid huge allocations; never crash on missing body.
- Filtering:
  - Date range must be inclusive and consistent across SQLite (watch DateTimeOffset sorting issues—use safe patterns already established).

## Test Plan
### Unit tests
- Ordering by timestamp desc
- Date range filter behavior (inclusive)
- Target/global-person filter behavior
- Cancellation is respected (if your query layer supports it)

### Integration tests (if applicable)
- Seed messages across multiple dates + participants in a temp workspace DB.
- Verify timeline results match expected ordering/filtering and that audit entry is written.

## How to Verify Manually
1. Open a case with ingested messages.
2. Navigate to Timeline; confirm it loads quickly and shows newest first.
3. Apply date range; confirm results change.
4. Filter by a target/global person; confirm only matching events show.
5. Use “View Source” and “Copy citation”; confirm correct provenance.

## Codex Instructions
- Use the new workflow: read **Docs/Tickets/T0024.md** + **Docs/Tickets/T0024.context.md** first.
- Follow canonical docs via links in the context pack (Invariants/Architecture/Data model/Workflow). Do not paste global rules into the ticket.
- Open/modify **only** files listed in the context pack whitelist.
  - If another file is required, update `T0024.context.md` **first**, then continue.
- Keep implementation offline-only, provenance-first, audited, and performant (paging + cancellation).
- End with: summary + files changed + manual verification steps.